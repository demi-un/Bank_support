from __future__ import annotations

from datetime import datetime
from typing import List, Dict, Tuple

from langchain.schema import HumanMessage, SystemMessage
from langchain_community.chat_models.gigachat import GigaChat

from .config import API_KEY


# ================== –ü–†–û–ú–ü–¢–´ ==================

CLASSIFIER_PROMPT = SystemMessage(content="""
–¢—ã –≤—ã—Å—Ç—É–ø–∞–µ—à—å –≤ —Ä–æ–ª–∏ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞ –æ–±—Ä–∞—â–µ–Ω–∏–π –∫–ª–∏–µ–Ω—Ç–æ–≤ –±–∞–Ω–∫–∞.
–û—Ç–≤–µ—Ç—å –¢–û–õ–¨–ö–û –æ–¥–Ω–∏–º —Å–ª–æ–≤–æ–º:
BANK ‚Äî –µ—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –∫ –±–∞–Ω–∫–æ–≤—Å–∫–∏–º –ø—Ä–æ–¥—É–∫—Ç–∞–º, —Å–µ—Ä–≤–∏—Å–∞–º –∏–ª–∏ –æ–ø–µ—Ä–∞—Ü–∏—è–º.
NON_BANK ‚Äî –µ—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –Ω–µ —Å–≤—è–∑–∞–Ω —Å –±–∞–Ω–∫–æ–≤—Å–∫–∏–º–∏ —É—Å–ª—É–≥–∞–º–∏.
""")

ANSWER_PROMPT = SystemMessage(content="""
–¢—ã –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –°–±–µ—Ä–±–∞–Ω–∫–∞.

–¢–í–û–Ø –ó–ê–î–ê–ß–ê:
- –û—Ç–≤–µ—á–∞—Ç—å –≤–µ–∂–ª–∏–≤–æ, –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ, *–∫—Ä–∞—Ç–∫–æ –∏ –ø–æ –¥–µ–ª—É*.
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¢–û–õ–¨–ö–û –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç, –ù–ï –¥–æ–±–∞–≤–ª—è—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ—Ç —Å–µ–±—è.
- –ï—Å–ª–∏ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –Ω–µ—Ç –ø—Ä—è–º–æ–≥–æ –æ—Ç–≤–µ—Ç–∞, –∫—Ä–∞—Ç–∫–æ –æ–± —ç—Ç–æ–º —Å–æ–æ–±—â–∏—Ç—å.

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê (Markdown –¥–ª—è Telegram):
- –ö–æ—Ä–æ—Ç–∫–æ–µ –≤—Å—Ç—É–ø–ª–µ–Ω–∏–µ (1‚Äì2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è) ‚Äî —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ.
- –û—Å–Ω–æ–≤–Ω–∞—è —á–∞—Å—Ç—å ‚Äî –≤ –≤–∏–¥–µ –º–∞—Ä–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Å–ø–∏—Å–∫–æ–≤ –∏–ª–∏ –∫–æ—Ä–æ—Ç–∫–∏—Ö –∞–±–∑–∞—Ü–µ–≤.
- –í—ã–¥–µ–ª—è–π –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ —Å –ø–æ–º–æ—â—å—é `*–∂–∏—Ä–Ω–æ–≥–æ*`.
- –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–µ —Ç–µ–∫—Å—Ç—ã (–¥–æ 5‚Äì7 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π).
""")

EXPENSE_PROMPT = SystemMessage(content="""
–¢—ã —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –°–±–µ—Ä–±–∞–Ω–∫–∞.
–¢–µ–±–µ –ø–µ—Ä–µ–¥–∞—é—Ç –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ —Ä–∞—Å—Ö–æ–¥–∞–º –∫–ª–∏–µ–Ω—Ç–∞ (–∫–∞—Ç–µ–≥–æ—Ä–∏–∏, —Å—É–º–º—ã, –¥–æ–ª–∏ –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö).

–¢–í–û–Ø –ó–ê–î–ê–ß–ê:
- –ö–æ—Ä–æ—Ç–∫–æ –∏ –ø–æ–Ω—è—Ç–Ω–æ –æ–±—ä—è—Å–Ω–∏—Ç—å –∫–∞—Ä—Ç–∏–Ω—É —Ä–∞—Å—Ö–æ–¥–æ–≤.
- –û—Ç–º–µ—Ç–∏—Ç—å 2‚Äì4 —Å–∞–º—ã—Ö –≤–∞–∂–Ω—ã—Ö –Ω–∞–±–ª—é–¥–µ–Ω–∏—è (–≥–¥–µ —Ç—Ä–∞—Ç –æ—Å–æ–±–µ–Ω–Ω–æ –º–Ω–æ–≥–æ / –º–∞–ª–æ).
- –î–∞—Ç—å –ø—Ä–∞–∫—Ç–∏—á–Ω—ã–µ —Å–æ–≤–µ—Ç—ã –ø–æ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–π –≥—Ä–∞–º–æ—Ç–Ω–æ—Å—Ç–∏ –ø—Ä–∏–º–µ–Ω–∏—Ç–µ–ª—å–Ω–æ –∫ —ç—Ç–∏–º –¥–∞–Ω–Ω—ã–º.

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê (Markdown –¥–ª—è Telegram):
- –ó–∞–≥–æ–ª–æ–≤–æ–∫: –æ–¥–Ω–∞ —Å—Ç—Ä–æ–∫–∞ —Å `*...*`.
- 1 –±–ª–æ–∫: –∫—Ä–∞—Ç–∫–∏–π –æ–±–∑–æ—Ä (2‚Äì3 –ø—É–Ω–∫—Ç–∞).
- 1 –±–ª–æ–∫: —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ (3‚Äì5 –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —Å–æ–≤–µ—Ç–æ–≤).
- –ò—Å–ø–æ–ª—å–∑—É–π –º–∞—Ä–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–ø–∏—Å–∫–∏ `- ...`.
- –í—ã–¥–µ–ª—è–π –≤–∞–∂–Ω—ã–µ —Å–ª–æ–≤–∞ —Å –ø–æ–º–æ—â—å—é `*–∂–∏—Ä–Ω–æ–≥–æ*`.
- –ù–µ –ø–∏—à–∏ –±–æ–ª—å—à–µ ~10‚Äì12 —Å—Ç—Ä–æ–∫.
""")

RECOMMEND_PROMPT = SystemMessage(content="""
–¢—ã –ø–æ–º–æ—â–Ω–∏–∫ –°–±–µ—Ä–±–∞–Ω–∫–∞.

–¢–µ–±–µ –ø–µ—Ä–µ–¥–∞—é—Ç:
- –≤–æ–ø—Ä–æ—Å –∫–ª–∏–µ–Ω—Ç–∞
- —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç –±–æ—Ç–∞

–¢–í–û–Ø –ó–ê–î–ê–ß–ê:
- –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å, –∫–∞–∫–∏–µ —Ä–∞–∑–¥–µ–ª—ã —Å–∞–π—Ç–∞ –°–±–µ—Ä–±–∞–Ω–∫–∞ –º–æ–≥—É—Ç –±—ã—Ç—å –Ω–∞–∏–±–æ–ª–µ–µ –ø–æ–ª–µ–∑–Ω—ã –∫–ª–∏–µ–Ω—Ç—É –ø–æ—Å–ª–µ —ç—Ç–æ–≥–æ –æ—Ç–≤–µ—Ç–∞.

–î–û–°–¢–£–ü–ù–´–ï –†–ê–ó–î–ï–õ–´ (–∫–∞—Ç–µ–≥–æ—Ä–∏–∏):
- "cards"      ‚Äî –±–∞–Ω–∫–æ–≤—Å–∫–∏–µ –∫–∞—Ä—Ç—ã, –¥–µ–±–µ—Ç–æ–≤—ã–µ/–∫—Ä–µ–¥–∏—Ç–Ω—ã–µ
- "deposits"   ‚Äî –≤–∫–ª–∞–¥—ã –∏ —Å–±–µ—Ä–µ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã
- "mortgage"   ‚Äî –∏–ø–æ—Ç–µ–∫–∞ –∏ –∂–∏–ª—å—ë
- "credits"    ‚Äî –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—å—Å–∫–∏–µ –∫—Ä–µ–¥–∏—Ç—ã, –∫—Ä–µ–¥–∏—Ç–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã
- "payments"   ‚Äî –ø–ª–∞—Ç–µ–∂–∏ –∏ –ø–µ—Ä–µ–≤–æ–¥—ã (–ñ–ö–•, –≥–æ—Å—É—Å–ª—É–≥–∏ –∏ —Ç.–ø.)
- "transfers"  ‚Äî –ø–µ—Ä–µ–≤–æ–¥—ã –º–µ–∂–¥—É —Å—á–µ—Ç–∞–º–∏ –∏ –≤ –¥—Ä—É–≥–∏–µ –±–∞–Ω–∫–∏
- "insurance"  ‚Äî —Å—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏–µ
- "investments"‚Äî –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏ –∏ –±—Ä–æ–∫–µ—Ä—Å–∫–∏–µ —É—Å–ª—É–≥–∏
- "support"    ‚Äî –ø–æ–º–æ—â—å –∏ —Å–ª—É–∂–±–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê:
- –í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û JSON-–º–∞—Å—Å–∏–≤ —Å—Ç—Ä–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–π, –±–µ–∑ –ø–æ—è—Å–Ω–µ–Ω–∏–π.
- –ü—Ä–∏–º–µ—Ä: ["cards", "deposits"]
- –ù–µ –±–æ–ª—å—à–µ 3 –∫–∞—Ç–µ–≥–æ—Ä–∏–π.
""")


# ================== –ö–õ–ò–ï–ù–¢ GIGACHAT ==================

giga = GigaChat(
    credentials=API_KEY,
    model="GigaChat",
    verify_ssl_certs=False,
    timeout=10
)


def classify_question(text: str) -> str:
    try:
        resp = giga.invoke([
            CLASSIFIER_PROMPT,
            HumanMessage(content=text)
        ])
        return resp.content.strip()
    except Exception:
        return "BANK"


def generate_answer(context: str, question: str) -> str:
    try:
        resp = giga.invoke([
            ANSWER_PROMPT,
            HumanMessage(content=f"–ö–æ–Ω—Ç–µ–∫—Å—Ç:\n{context}\n\n–í–æ–ø—Ä–æ—Å:\n{question}")
        ])
        return resp.content
    except Exception:
        return "‚ö†Ô∏è –°–µ—Ä–≤–∏—Å –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –∑–∞–ø—Ä–æ—Å —á—É—Ç—å –ø–æ–∑–∂–µ."


def analyze_expenses(expenses: List[Dict]) -> str:
    """
    –ê–Ω–∞–ª–∏–∑ —Ç—Ä–∞—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∏ GigaChat.
    –û–∂–∏–¥–∞–µ—Ç—Å—è —Å–ø–∏—Å–æ–∫ –æ–ø–µ—Ä–∞—Ü–∏–π —Å –ø–æ–ª—è–º–∏: date, time, description, amount, category.
    """
    if not expenses:
        return "–í —Ñ–∞–π–ª–µ –Ω–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π ‚Äî –Ω–µ—á–µ–≥–æ –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å."

    total_spent = 0
    by_category: Dict[str, float] = {}

    for op in expenses:
        amount = op.get("amount", 0)
        category = op.get("category", "–ø—Ä–æ—á–µ–µ")
        # —Å—á–∏—Ç–∞–µ–º —Ç–æ–ª—å–∫–æ —Ä–∞—Å—Ö–æ–¥—ã (–æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ —Å—É–º–º—ã)
        if amount < 0:
            value = abs(amount)
            total_spent += value
            by_category[category] = by_category.get(category, 0) + value

    if total_spent == 0:
        return "–í —Ñ–∞–π–ª–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ —Ä–∞—Å—Ö–æ–¥–æ–≤ (–æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã—Ö —Å—É–º–º) ‚Äî –≤–æ–∑–º–æ–∂–Ω–æ, —ç—Ç–æ –Ω–µ —Ç–æ—Ç —Ñ–∞–π–ª."

    # —Å–æ—Ä—Ç–∏—Ä—É–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø–æ —É–±—ã–≤–∞–Ω–∏—é —Ç—Ä–∞—Ç
    top_cats: List[Tuple[str, float]] = sorted(by_category.items(), key=lambda x: x[1], reverse=True)

    # –≥–æ—Ç–æ–≤–∏–º –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ –≤–∏–¥–µ —Ç–µ–∫—Å—Ç–∞-–∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –¥–ª—è GigaChat
    lines = []
    lines.append(f"–û–±—â–∞—è —Å—É–º–º–∞ —Ä–∞—Å—Ö–æ–¥–æ–≤ –≤ –≤—ã–±–æ—Ä–∫–µ: {total_spent:,.0f} ‚ÇΩ".replace(",", " "))
    lines.append("–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ (—Å—É–º–º–∞, –¥–æ–ª—è %):")

    for cat, amt in top_cats:
        share = amt / total_spent * 100
        lines.append(f"- {cat}: {amt:,.0f} ‚ÇΩ ({share:.1f}%)".replace(",", " "))

    context = "\n".join(lines)

    try:
        resp = giga.invoke([
            EXPENSE_PROMPT,
            HumanMessage(content=context)
        ])
        return resp.content
    except Exception:
        # –∑–∞–ø–∞—Å–Ω–æ–π –ø—Ä–æ—Å—Ç–æ–π —Ç–µ–∫—Å—Ç, –µ—Å–ª–∏ –∞–Ω–∞–ª–∏–∑ —á–µ—Ä–µ–∑ GigaChat –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
        fallback_lines = []
        fallback_lines.append("üìä *–ö—Ä–∞—Ç–∫–∏–π –æ–±–∑–æ—Ä —Ä–∞—Å—Ö–æ–¥–æ–≤*")
        fallback_lines.append("")
        fallback_lines.append(f"–û–±—â–∞—è —Å—É–º–º–∞ —Ä–∞—Å—Ö–æ–¥–æ–≤: *{total_spent:,.0f} ‚ÇΩ*".replace(",", " "))
        fallback_lines.append("")
        fallback_lines.append("–ü–æ –æ—Å–Ω–æ–≤–Ω—ã–º –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º:")
        for cat, amt in top_cats[:5]:
            share = amt / total_spent * 100
            fallback_lines.append(f"- *{cat}*: {amt:,.0f} ‚ÇΩ ({share:.1f}%)".replace(",", " "))
        fallback_lines.append("")
        fallback_lines.append("üí° –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ç—Ä–∞—Ç—ã –∏ –æ—Å—Ç–∞–≤–∏—Ç—å –∑–∞–ø–∞—Å 10‚Äì20% –¥–æ—Ö–æ–¥–∞ –Ω–∞ —Å–±–µ—Ä–µ–∂–µ–Ω–∏—è.")
        return "\n".join(fallback_lines)


def get_recommendation_tags(question: str, answer: str) -> List[str]:
    """
    –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –∫–∞–∫–∏–µ —Ä–∞–∑–¥–µ–ª—ã —Å–∞–π—Ç–∞ –°–±–µ—Ä–±–∞–Ω–∫–∞ –ø–æ—Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.
    –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–ø–∏—Å–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –∏–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–≥–æ –º–Ω–æ–∂–µ—Å—Ç–≤–∞.
    """
    allowed = {
        "cards",
        "deposits",
        "mortgage",
        "credits",
        "payments",
        "transfers",
        "insurance",
        "investments",
        "support",
    }

    try:
        import json as _json

        resp = giga.invoke([
            RECOMMEND_PROMPT,
            HumanMessage(content=f"–í–æ–ø—Ä–æ—Å –∫–ª–∏–µ–Ω—Ç–∞:\n{question}\n\n–û—Ç–≤–µ—Ç –±–æ—Ç–∞:\n{answer}")
        ])
        raw = resp.content.strip()
        data = _json.loads(raw)
        if not isinstance(data, list):
            return []

        out: List[str] = []
        for item in data:
            if not isinstance(item, str):
                continue
            key = item.strip().lower()
            if key in allowed and key not in out:
                out.append(key)
        return out[:3]
    except Exception:
        return []


